name: Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  unit-tests:
    name: 單元測試
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v3

    - name: 設置 Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: 安裝 uv
      uses: astral-sh/setup-uv@v4

    - name: 安裝依賴
      run: |
        uv pip install --system -r requirements.txt

    - name: 運行單元測試
      run: |
        python tests/run_all_tests.py --suite unit

  api-tests:
    name: API 測試
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests

    steps:
    - uses: actions/checkout@v3

    - name: 設置 Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: 安裝 uv
      uses: astral-sh/setup-uv@v4

    - name: 安裝依賴
      run: |
        uv pip install --system -r requirements.txt

    - name: 創建測試數據庫
      run: |
        mkdir -p data
        python -c "import duckdb; duckdb.connect('data/corpus.duckdb').close()"

    - name: 運行 API 測試
      run: |
        python tests/run_all_tests.py --suite api
      env:
        REQUESTY_API_KEY: ${{ secrets.REQUESTY_API_KEY }}
        GLM_API_KEY: "dummy"
        MINIMAX_API_KEY: "dummy"
        GEMINI_API_KEY: "dummy"

  # 整合測試需要本地 Proxy，跳過 CI
  # integration-tests:
  #   name: 整合測試
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 20
  #   needs: api-tests
  #
  #   steps:
  #   - uses: actions/checkout@v3
  #   ...

  all-tests:
    name: 所有測試狀態
    runs-on: ubuntu-latest
    needs: [unit-tests, api-tests]
    if: always()

    steps:
    - name: 檢查測試結果
      run: |
        echo "單元測試: ${{ needs.unit-tests.result }}"
        echo "API 測試: ${{ needs.api-tests.result }}"

        if [ "${{ needs.unit-tests.result }}" != "success" ] || [ "${{ needs.api-tests.result }}" != "success" ]; then
          echo "❌ 測試失敗"
          exit 1
        else
          echo "✅ 所有測試通過"
        fi
